<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">🌕</p>
      <p class="dark">🌑</p>
    </div>
  </label>
</div>

{%- assign name = 'night_mode' -%}
{%- include functions.html func='get_value' default='auto' -%}
{%- assign night_mode = return -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var giscusScript = document.getElementById('giscus-script');
    var giscusContainer = document.getElementById('giscus_thread');
    var nightModeOption = ('{{ night_mode }}' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual' ? localStorage : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';

      // 设置搜索框背景色
      var searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.style.backgroundColor = nightShift ? '#333' : '#fff';
        searchInput.style.color = nightShift ? '#fff' : '#000';
      }

      giscusScript.setAttribute('data-theme', nightShift ? 'noborder_dark' : 'noborder_light');
      // Reload the giscus iframe to apply the new theme
      giscusContainer.innerHTML = '';
      var newScript = document.createElement('script');
      newScript.src = giscusScript.src;
      newScript.setAttribute('data-repo', giscusScript.getAttribute('data-repo'));
      newScript.setAttribute('data-repo-id', giscusScript.getAttribute('data-repo-id'));
      newScript.setAttribute('data-category', giscusScript.getAttribute('data-category'));
      newScript.setAttribute('data-category-id', giscusScript.getAttribute('data-category-id'));
      newScript.setAttribute('data-mapping', giscusScript.getAttribute('data-mapping'));
      newScript.setAttribute('data-strict', giscusScript.getAttribute('data-strict'));
      newScript.setAttribute('data-reactions-enabled', giscusScript.getAttribute('data-reactions-enabled'));
      newScript.setAttribute('data-emit-metadata', giscusScript.getAttribute('data-emit-metadata'));
      newScript.setAttribute('data-input-position', giscusScript.getAttribute('data-input-position'));
      newScript.setAttribute('data-theme', giscusScript.getAttribute('data-theme'));
      newScript.setAttribute('data-lang', giscusScript.getAttribute('data-lang'));
      newScript.setAttribute('data-loading', giscusScript.getAttribute('data-loading'));
      newScript.setAttribute('crossorigin', giscusScript.getAttribute('crossorigin'));
      newScript.async = true;
      giscusContainer.appendChild(newScript);
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <= 7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  });
</script>
